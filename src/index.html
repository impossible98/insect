<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>insect</title>
    <link rel="stylesheet" href="terminal.css">
    <link rel="stylesheet" href="main.css">
    <script src="insect.js"></script>
    <script src="keyboardevent-key-polyfill.js"></script>
    <script src="jquery.min.js"></script>
    <script src="jquery.terminal.min.js"></script>
    <script src="jquery.mousewheel-min.js"></script>
    <script>
        keyboardeventKeyPolyfill.polyfill();

        let insectEnv = Insect.initialEnvironment;
        let clearCommands = ["clear", "cls", "quit", "exit"];

        function updateUrl(url) {
            history.replaceState(null, null, url);
        }

        function interpret(line) {
            let lineTrimmed = line.trim();
            if (lineTrimmed === "" || lineTrimmed[0] === "#") {
                return undefined;
            }

            let res = Insect.repl(Insect.fmtJqueryTerminal)(insectEnv)(line);
            insectEnv = res.newEnv;

            if (clearCommands.includes(res.msgType)) {
                updateUrl("");
            }

            if (res.msgType === "clear") {
                this.clear();
                return "";
            } else if (res.msgType === "quit") {
                this.clear();
                insectEnv = Insect.initialEnvironment;
                return "";
            }

            if (res.msgType === "error") {
                ga('send', 'event', 'user-input', 'error', line);
            } else {
                ga('send', 'event', 'user-input', 'success', line);
            }

            updateUrl(`?q=${encodeURIComponent(line)}`);

            return res.msg;
        }

        function emph(str) {
            return `[[;;;hl-emphasized]${str}]`;
        }

        function colored(col, str) {
            return `[[;#${col};]${str}]`;
        }

        let visitedBefore = localStorage.getItem("visitedBefore") === "yes";
        let greeting = "";

        if (!visitedBefore) {
            greeting = colored("75715E", "Welcome to insect. Type '?' if this is your first visit.");
            localStorage.setItem("visitedBefore", "yes");
        } else {
            greeting = colored("75715E", "Welcome to insect. Enter '?' for help.");
        }

        $(document).ready(() => {
            const term = $('#terminal').terminal(interpret, {
                greetings: greeting,
                name: "terminal",
                height: 550,
                prompt: "[[;;;prompt]&#8811; ]",
                clear: false,
                exit: false,
                checkArity: false,
                historySize: 200,
                historyFilter(line) {
                    return line.trim() !== "";
                },
                completion(inp, cb) {
                    const identifiers = Insect.identifiers(insectEnv);
                    const keywords =
                        identifiers.concat(Insect.functions(insectEnv))
                            .concat(Insect.supportedUnits)
                            .concat(Insect.commands);

                    cb(keywords.sort());
                },
                completionEscape: false,
                keymap: {
                    "CTRL+L": function () {
                        updateUrl("");
                        term.clear();
                    }
                }
            });

            if (location.search) {
                const queryParams = {};
                location.search.replace(/\?([^=&]+)=([^&]*)/g, (match, paramName, paramValue) => {
                    queryParams[paramName] = paramValue;
                });
                if (queryParams.q) {
                    const cmd = decodeURIComponent(queryParams.q.replace(/\+/g, " "));
                    term.exec(cmd);
                }
            }
        });
    </script>
</head>

<body>
    <div id="content">
        <img src="assets/insect.svg" title="insect - scientific calculator" alt="insect - scientific calculator">
        <div id="terminal"></div>
    </div>
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-39945208-7', 'auto');
        ga('send', 'pageview');
    </script>
</body>

</html>